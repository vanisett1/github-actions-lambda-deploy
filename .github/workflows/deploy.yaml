name: Deploy Changed Lambdas

on:
  push:
    branches:
      - dev
    paths:
      - 'lambdas/**'  # Trigger only when there are changes in the lambdas directory

jobs:
  find_changed_lambdas:
    runs-on: ubuntu-latest
    outputs:
      lambdas: ${{ steps.set_output.outputs.lambdas }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 2  # Fetch the last two commits to ensure HEAD^ is valid

      - name: Find modified Lambda paths
        id: set_output
        run: |
          echo "Finding modified Lambda paths..."
          # Get the list of changed directories in lambdas
          changed_dirs=$(git diff --name-only HEAD^ HEAD lambdas/ | grep '/$' | cut -d'/' -f2 | sort -u | jq -R . | jq -s .)
          echo "Changed lambdas: $changed_dirs"
          echo "lambdas=$changed_dirs" >> $GITHUB_ENV  # Set output using environment files
          echo "::set-output name=lambdas::$changed_dirs"  # Set output for the next job

      - name: Debug Output
        run: |
          echo "Output from find_changed_lambdas: ${{ steps.set_output.outputs.lambdas }}"

  deploy:
    runs-on: ubuntu-latest
    needs: find_changed_lambdas
    if: steps.set_output.outputs.lambdas != '[]'  # Only run if there are changed lambdas
    strategy:
      matrix:
        lambda_path: ${{ fromJson(steps.set_output.outputs.lambdas) }}  # Get the changed lambda paths

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          cd lambdas/${{ matrix.lambda_path }}
          npm install

      - name: Build Lambda
        run: |
          cd lambdas/${{ matrix.lambda_path }}
          npm run build

      - name: Deploy Lambda
        run: |
          cd lambdas/${{ matrix.lambda_path }}
          # Add your deployment command here
          echo "Deploying Lambda from ${matrix.lambda_path}..."